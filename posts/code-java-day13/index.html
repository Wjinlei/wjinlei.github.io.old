<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/css/custom-bootstrap.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>Java学习笔记(爬虫项目)</title>
</head>
<body class="container"><div id="fastSearch">
  <input id="searchInput" tabindex="0">
  <ul id="searchResults"></ul>
</div>

<div style="margin: 40px; display: flex; justify-content: space-between; align-items: end;">
  <div>
  
  
  <h2>Jerry&#39;s Blog</h2>
  <span class="color-999 font-size-14">珍爱生命，远离卷王，拒绝内卷，从我做起。温馨提示: 按 Alt&#43;/ 可以搜索哦 ^_^</span>
  </div>
</div>


<div id="nav-border" style="margin: 30px 0px 30px 0px;">
  <ul class="nav nav-tabs" style="justify-content: space-between">
    <div class="nav" style="padding: 0px;">
    
    <li class="nav-item">
      <a class="nav-link active" href="/">
      
      
      <i data-feather="home"></i> 
      
      
      首页
      </a>
    </li>
    
    <li class="nav-item">
      <a class="nav-link active" href="/posts/">
      
      
      <i data-feather="pen-tool"></i> 
      
      
      文章
      </a>
    </li>
    
    </div>

    <div class="d-none d-lg-block d-xl-block d-xxl-block">
      <div class="nav" style="padding: 0px;">
      
      <li class="nav-item">
        <a class="nav-link active" href="#">
        
        
        QQ:1976883731
        </a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link active" href="#">
        
        
        WeChat:JerryWang1996
        </a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link active" href="https://github.com/Wjinlei">
        
        
        <i data-feather="github"></i> 
        
        
        Wjinlei
        </a>
      </li>
      
      <li class="nav-item">
        <a class="nav-link active" href="mailto:freebufer.wang@gmail.com">
        
        
        <i data-feather="mail"></i> 
        
        
        freebufer.wang@gmail.com
        </a>
      </li>
      
      </div>
    </div>
  </ul>
</div>

<style>
 #fastSearch {
    visibility: hidden;
    display: inline-block;
    position: absolute;
    padding: 0;
    width: 320px;
    right: 10px;
    top: 10px;
  }

  #fastSearch input {
    outline: none;
    text-align: left;
    display: inline-block;
    color: #222129;
    background-color: #EEE;
    border: 2px solid #444;
    padding: 4px;
    width: 100%;
    height: 31px;
  }

  #searchResults li {
    list-style: none;
    background-color: #fafede;
    border-bottom: 1px dotted #000;
  }

  #searchResults li .title {
    display: inline-block;
    margin: 0;
  }

  #searchResults {
    visibility: inherit;
    display: inline-block;
    overflow: hidden;
    width: 320px;
    max-height: calc(100vh - 120px);
    padding: 0;
    margin: 0;
  }

  #searchResults a {
    text-decoration: none !important;
    padding: 2px;
    display: inline-block;
    width: 100%;
  }

  #searchResults a:hover, #searchResults a:focus {
    outline: 0;
    background-color: #666;
    color: #fff;
  }
</style>
<div id="content">
<div>
<h4>Java学习笔记(爬虫项目)</h4>
<span class="font-size-14 color-999">本文共 5346 字，阅读约 26 分钟</span>


<div class="color-999 font-size-14">
<time datetime="2021-11-11">2021-11-11 20:51:37</time>

<i data-feather="tag"></i>


<a href="http://wjinlei.github.io/tags/java">java</a>


</div>

<br><br>
<h2 id="从零开始做一个项目的原则">从零开始做一个项目的原则</h2>
<ul>
<li>把每个项目都当作人生中最好的一个项目来精雕细琢
<ul>
<li>积累自己的<code>Reputation</code>(声誉)</li>
<li>一丝不苟的写好文档</li>
<li>代码质量++</li>
</ul>
</li>
<li>使用标准化业,界公认的模式和流程</li>
<li>(几乎)没有本地依赖,使用者能够好无障碍的运行</li>
<li>小步快跑
<ul>
<li>成就感</li>
<li>越小的变更越容易<code>debug</code></li>
</ul>
</li>
</ul>
<h2 id="开发约定">开发约定</h2>
<ul>
<li>[强制] 使用<code>Github</code>+<code>主干</code>&amp;<code>分支</code>模型进行开发
<ul>
<li>禁止直接<code>push master</code></li>
<li>所有变更通过<code>PR</code>进行</li>
</ul>
</li>
<li>[强制] 自动化代码质量检查+测试
<ul>
<li>越早代价越低</li>
<li><code>Checkstyle</code>/<code>SpotBugs</code></li>
<li>最基本的自动化测试覆盖</li>
</ul>
</li>
<li>[尽量] 一切工作自动化</li>
<li>规范提交流程</li>
</ul>
<h2 id="项目的推进流程">项目的推进流程</h2>
<ul>
<li>多人协作
<ul>
<li>模块化
<ul>
<li>各模块之间职责明确,界限清晰</li>
<li>基本的文档</li>
<li>基本的接口</li>
</ul>
</li>
<li>小步提交
<ul>
<li>大的变更更加难以<code>review</code></li>
<li>大的变更冲突更加棘手</li>
</ul>
</li>
</ul>
</li>
<li>单打独斗
<ul>
<li>先实现功能</li>
<li>再实现的过程中不停的抽取公共部分
<ul>
<li>每当写出很长很啰嗦的代码的时候,就需要重构了</li>
<li>每当你复制粘贴的时候,就需要重构了</li>
</ul>
</li>
<li>通过重构实现模块化,接口化</li>
</ul>
</li>
</ul>
<h2 id="爬虫项目算法">爬虫项目算法</h2>
<ul>
<li>从一个节点开始,遍历所有的节点</li>
<li>采用<code>广度优先算法</code>
<ul>
<li>优先遍历同层次的节点
<img src="/images/project-test-crawler/01.png" alt="广度优先"></li>
</ul>
</li>
</ul>
<h3 id="算法流程">算法流程</h3>
<ol>
<li>一开始有个链接池</li>
<li>从链接池中拿一个链接,判断是否处理过
<ol>
<li>处理过,重新从池子中拿一个链接</li>
<li>没有处理过,是我们想要的吗?
<ol>
<li>不是,重新从池子拿一个链接</li>
<li>是我们想要的,处理它,把新得到的链接放入链接池
<ol>
<li>如果是新闻的话,存储它</li>
<li>然后把链接加入已处理的链接池中</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li>重新从2开始
<img src="/images/project-test-crawler/02.png" alt="算法图解"></li>
</ol>
<h2 id="原始代码">原始代码</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.HttpGet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.HttpClients</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.util.EntityUtils</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.Jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Document</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Element</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.select.Elements</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.IOException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.ArrayList</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.HashSet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Main</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">main</span><span style="color:#f92672">(</span><span style="color:#111">String</span><span style="color:#f92672">[]</span> <span style="color:#111">args</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ArrayList</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">&gt;</span> <span style="color:#111">unHandledPool</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">ArrayList</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">HashSet</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">&gt;</span> <span style="color:#111">handledPool</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HashSet</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">unHandledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">add</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;https://sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">while</span> <span style="color:#f92672">(</span><span style="color:#00a8c8">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">unHandledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">String</span> <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#111">unHandledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">get</span><span style="color:#f92672">(</span><span style="color:#111">unHandledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> <span style="color:#111">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">unHandledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">remove</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">handledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">startsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;//&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;https:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(!</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;passport.sina.cn&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span><span style="color:#d88200">&#34;https://sina.cn&#34;</span><span style="color:#f92672">.</span><span style="color:#75af00">equals</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;news.sina.cn&#34;</span><span style="color:#f92672">)))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">CloseableHttpClient</span> <span style="color:#111">document</span> <span style="color:#f92672">=</span> <span style="color:#111">HttpClients</span><span style="color:#f92672">.</span><span style="color:#75af00">createDefault</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">HttpGet</span> <span style="color:#111">request</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HttpGet</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#75af00">setHeader</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;User-Agent&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#d88200">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">CloseableHttpResponse</span> <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">document</span><span style="color:#f92672">.</span><span style="color:#75af00">execute</span><span style="color:#f92672">(</span><span style="color:#111">request</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">String</span> <span style="color:#111">html</span> <span style="color:#f92672">=</span> <span style="color:#111">EntityUtils</span><span style="color:#f92672">.</span><span style="color:#75af00">toString</span><span style="color:#f92672">(</span><span style="color:#111">response</span><span style="color:#f92672">.</span><span style="color:#75af00">getEntity</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">Document</span> <span style="color:#111">parse</span> <span style="color:#f92672">=</span> <span style="color:#111">Jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">parse</span><span style="color:#f92672">(</span><span style="color:#111">html</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">a</span> <span style="color:#f92672">:</span> <span style="color:#111">parse</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#111">String</span> <span style="color:#111">href</span> <span style="color:#f92672">=</span> <span style="color:#111">a</span><span style="color:#f92672">.</span><span style="color:#75af00">attr</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;href&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#111">unHandledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">add</span><span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">Elements</span> <span style="color:#111">articles</span> <span style="color:#f92672">=</span> <span style="color:#111">parse</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;article&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#00a8c8">if</span> <span style="color:#f92672">(!</span><span style="color:#111">articles</span><span style="color:#f92672">.</span><span style="color:#75af00">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">article</span> <span style="color:#f92672">:</span> <span style="color:#111">articles</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">out</span><span style="color:#f92672">.</span><span style="color:#75af00">println</span><span style="color:#f92672">(</span><span style="color:#111">article</span><span style="color:#f92672">.</span><span style="color:#75af00">child</span><span style="color:#f92672">(</span><span style="color:#111">0</span><span style="color:#f92672">).</span><span style="color:#75af00">text</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">handledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">add</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="第一次重构">第一次重构</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.HttpGet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.HttpClients</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.util.EntityUtils</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.Jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Document</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Element</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.select.Elements</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.IOException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.ArrayList</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.HashSet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Main</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">main</span><span style="color:#f92672">(</span><span style="color:#111">String</span><span style="color:#f92672">[]</span> <span style="color:#111">args</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ArrayList</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">&gt;</span> <span style="color:#111">unHandledPool</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">ArrayList</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">HashSet</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">&gt;</span> <span style="color:#111">handledPool</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HashSet</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">unHandledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">add</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;https://sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">while</span> <span style="color:#f92672">(!</span><span style="color:#111">unHandledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">String</span> <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#111">unHandledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">remove</span><span style="color:#f92672">(</span><span style="color:#111">unHandledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">size</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> <span style="color:#111">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">handledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">Document</span> <span style="color:#111">jsoup</span> <span style="color:#f92672">=</span> <span style="color:#111">Jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">parse</span><span style="color:#f92672">(</span><span style="color:#111">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#f92672">).</span><span style="color:#75af00">stream</span><span style="color:#f92672">().</span><span style="color:#75af00">map</span><span style="color:#f92672">(</span><span style="color:#111">a</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">a</span><span style="color:#f92672">.</span><span style="color:#75af00">attr</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;href&#34;</span><span style="color:#f92672">)).</span><span style="color:#75af00">forEach</span><span style="color:#f92672">(</span><span style="color:#111">unHandledPool</span><span style="color:#f92672">::</span><span style="color:#111">add</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">storeNewsToDatabase</span><span style="color:#f92672">(</span><span style="color:#111">jsoup</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">handledPool</span><span style="color:#f92672">.</span><span style="color:#75af00">add</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get HTML content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return html body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IOException IOException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">String</span> <span style="color:#75af00">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">startsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;//&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;https:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">CloseableHttpClient</span> <span style="color:#111">document</span> <span style="color:#f92672">=</span> <span style="color:#111">HttpClients</span><span style="color:#f92672">.</span><span style="color:#75af00">createDefault</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">HttpGet</span> <span style="color:#111">request</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HttpGet</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#75af00">setHeader</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;User-Agent&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d88200">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">CloseableHttpResponse</span> <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">document</span><span style="color:#f92672">.</span><span style="color:#75af00">execute</span><span style="color:#f92672">(</span><span style="color:#111">request</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">EntityUtils</span><span style="color:#f92672">.</span><span style="color:#75af00">toString</span><span style="color:#f92672">(</span><span style="color:#111">response</span><span style="color:#f92672">.</span><span style="color:#75af00">getEntity</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the desired link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span><span style="color:#111">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#111">isNews</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a login page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#f92672">!</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;passport.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the home page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;https://sina.cn&#34;</span><span style="color:#f92672">.</span><span style="color:#75af00">equals</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a news page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;news.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Save news to database
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param jsoup Jsoup parse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">storeNewsToDatabase</span><span style="color:#f92672">(</span><span style="color:#111">Document</span> <span style="color:#111">jsoup</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Elements</span> <span style="color:#111">articles</span> <span style="color:#f92672">=</span> <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;article&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(!</span><span style="color:#111">articles</span><span style="color:#f92672">.</span><span style="color:#75af00">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">article</span> <span style="color:#f92672">:</span> <span style="color:#111">articles</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">out</span><span style="color:#f92672">.</span><span style="color:#75af00">println</span><span style="color:#f92672">(</span><span style="color:#111">article</span><span style="color:#f92672">.</span><span style="color:#75af00">child</span><span style="color:#f92672">(</span><span style="color:#111">0</span><span style="color:#f92672">).</span><span style="color:#75af00">text</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="maven-生命周期">Maven 生命周期</h2>
<p>Maven会从头往下执行,当它执行到某个阶段的时候,它会看看这个阶段有没有什么工作要作<br>
如果没有什么工作要作,他就继续向下执行,如果有对应工作要做,就执行对应工作.<br>
工作是通过插件的形式绑定到指定生命周期阶段的,Maven中一个插件目标称为<code>goal</code></p>
<ul>
<li>
<p>Maven有哪些生命周期阶段?
<img src="/images/project-test-crawler/03.png" alt="Maven生命周期"></p>
</li>
<li>
<p>其中常用的有</p>
<ol>
<li>compile -&gt; maven-compile-plugin</li>
<li>test -&gt; maven-surefire-plugin</li>
<li>package</li>
<li>verify</li>
<li>install</li>
<li>deploy</li>
</ol>
</li>
<li>
<p>下面是一个插件绑定到compile阶段的例子</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;artifactId&gt;</span>maven-checkstyle-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;version&gt;</span>3.1.0<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;configLocation&gt;</span>${basedir}/.circleci/checkstyle.xml<span style="color:#f92672">&lt;/configLocation&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;includeTestSourceDirectory&gt;</span>true<span style="color:#f92672">&lt;/includeTestSourceDirectory&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;enableRulesSummary&gt;</span>false<span style="color:#f92672">&lt;/enableRulesSummary&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;id&gt;</span>compile<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;phase&gt;</span>compile<span style="color:#f92672">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">&lt;goal&gt;</span>check<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;groupId&gt;</span>com.puppycrawl.tools<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;artifactId&gt;</span>checkstyle<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;version&gt;</span>8.29<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span></code></pre></div><h2 id="第二次重构引入数据库实现断点续传">第二次重构,引入数据库实现断点续传</h2>
<p><img src="/images/project-test-crawler/04.png" alt="数据库定义"></p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.HttpGet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.HttpClients</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.util.EntityUtils</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.Jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Document</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Element</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.select.Elements</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.File</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.IOException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.Connection</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.DriverManager</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.PreparedStatement</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.ResultSet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.ArrayList</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Main</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">Connection</span> <span style="color:#111">connection</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">main</span><span style="color:#f92672">(</span><span style="color:#111">String</span><span style="color:#f92672">[]</span> <span style="color:#111">args</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span><span style="color:#f92672">,</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">setConnection</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">while</span> <span style="color:#f92672">(!</span><span style="color:#111">selectUnHandledUrls</span><span style="color:#f92672">().</span><span style="color:#75af00">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">String</span> <span style="color:#111">url</span> <span style="color:#f92672">=</span> <span style="color:#111">removeUnHandledMaxUrl</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">url</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">selectInHandledWhereUrl</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">))</span> <span style="color:#00a8c8">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">Document</span> <span style="color:#111">jsoup</span> <span style="color:#f92672">=</span> <span style="color:#111">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#f92672">(</span><span style="color:#111">jsoup</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">updateUrlWithSql</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;INSERT INTO LINKS_IN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Load links from databases
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return ArrayList
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">ArrayList</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">&gt;</span> <span style="color:#75af00">selectUnHandledUrls</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ArrayList</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">&gt;</span> <span style="color:#111">list</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">ArrayList</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span> <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;SELECT link FROM LINKS_UN_HANDLED&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>             <span style="color:#111">ResultSet</span> <span style="color:#111">resultSet</span> <span style="color:#f92672">=</span> <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeQuery</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">while</span> <span style="color:#f92672">(</span><span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">next</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">list</span><span style="color:#f92672">.</span><span style="color:#75af00">add</span><span style="color:#f92672">(</span><span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">getString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">list</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * DELETE FROM LINKS_UN_HANDLED WHERE link = (SELECT max(id) FROM LINKS_UN_HANDLED)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return return deleted link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">String</span> <span style="color:#75af00">removeUnHandledMaxUrl</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span> <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d88200">&#34;SELECT * FROM LINKS_UN_HANDLED WHERE id=(SELECT max(id) FROM LINKS_UN_HANDLED)&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>             <span style="color:#111">ResultSet</span> <span style="color:#111">resultSet</span> <span style="color:#f92672">=</span> <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeQuery</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">next</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">String</span> <span style="color:#111">url</span> <span style="color:#f92672">=</span> <span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">getString</span><span style="color:#f92672">(</span><span style="color:#111">2</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">updateUrlWithSql</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;DELETE FROM LINKS_UN_HANDLED WHERE link = ?&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#111">url</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * SELECT link FROM LINKS_IN_HANDLED WHERE link = ?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return if exists return true, else return false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">selectInHandledWhereUrl</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;SELECT link FROM LINKS_IN_HANDLED WHERE link = ?&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">ResultSet</span> <span style="color:#111">resultSet</span> <span style="color:#f92672">=</span> <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeQuery</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">next</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * parse html to a tag, and &#39;INSERT INTO LINKS_UN_HANDLED&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return Jsoup Document
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IOException  IOException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">Document</span> <span style="color:#75af00">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">,</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Document</span> <span style="color:#111">jsoup</span> <span style="color:#f92672">=</span> <span style="color:#111">Jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">parse</span><span style="color:#f92672">(</span><span style="color:#111">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">a</span> <span style="color:#f92672">:</span> <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">String</span> <span style="color:#111">href</span> <span style="color:#f92672">=</span> <span style="color:#111">a</span><span style="color:#f92672">.</span><span style="color:#75af00">attr</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;href&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">updateUrlWithSql</span><span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;INSERT INTO LINKS_UN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * executeUpdate for link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param sql  sql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateUrlWithSql</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">sql</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#111">sql</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeUpdate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get HTML content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return html body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IOException IOException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">String</span> <span style="color:#75af00">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">startsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;//&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;https:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">CloseableHttpClient</span> <span style="color:#111">document</span> <span style="color:#f92672">=</span> <span style="color:#111">HttpClients</span><span style="color:#f92672">.</span><span style="color:#75af00">createDefault</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">HttpGet</span> <span style="color:#111">request</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HttpGet</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#75af00">setHeader</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;User-Agent&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d88200">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">CloseableHttpResponse</span> <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">document</span><span style="color:#f92672">.</span><span style="color:#75af00">execute</span><span style="color:#f92672">(</span><span style="color:#111">request</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">EntityUtils</span><span style="color:#f92672">.</span><span style="color:#75af00">toString</span><span style="color:#f92672">(</span><span style="color:#111">response</span><span style="color:#f92672">.</span><span style="color:#75af00">getEntity</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Save news to database
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param jsoup Jsoup parse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#f92672">(</span><span style="color:#111">Document</span> <span style="color:#111">jsoup</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Elements</span> <span style="color:#111">articles</span> <span style="color:#f92672">=</span> <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;article&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(!</span><span style="color:#111">articles</span><span style="color:#f92672">.</span><span style="color:#75af00">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">article</span> <span style="color:#f92672">:</span> <span style="color:#111">articles</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">out</span><span style="color:#f92672">.</span><span style="color:#75af00">println</span><span style="color:#f92672">(</span><span style="color:#111">article</span><span style="color:#f92672">.</span><span style="color:#75af00">child</span><span style="color:#f92672">(</span><span style="color:#111">0</span><span style="color:#f92672">).</span><span style="color:#75af00">text</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the desired link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span><span style="color:#111">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#111">isNews</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the home page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;https://sina.cn&#34;</span><span style="color:#f92672">.</span><span style="color:#75af00">equals</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a login page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#f92672">!</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;passport.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a news page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;news.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Set database connection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">setConnection</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">File</span> <span style="color:#111">projectDir</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">File</span><span style="color:#f92672">(</span><span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">getProperty</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;basedir&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">getProperty</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;user.dir&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">String</span> <span style="color:#111">jdbcUrl</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;jdbc:h2:file:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#00a8c8">new</span> <span style="color:#111">File</span><span style="color:#f92672">(</span><span style="color:#111">projectDir</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;news&#34;</span><span style="color:#f92672">).</span><span style="color:#75af00">getAbsolutePath</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">connection</span> <span style="color:#f92672">=</span> <span style="color:#111">DriverManager</span><span style="color:#f92672">.</span><span style="color:#75af00">getConnection</span><span style="color:#f92672">(</span><span style="color:#111">jdbcUrl</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;root&#34;</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;toor&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="利用flyway自动化迁移数据库">利用flyway自动化迁移数据库</h2>
<ul>
<li>pom.xml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.flywaydb<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>flyway-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>8.0.4<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;url&gt;</span>jdbc:h2:file:./news<span style="color:#f92672">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;user&gt;</span>root<span style="color:#f92672">&lt;/user&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;password&gt;</span>toor<span style="color:#f92672">&lt;/password&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>com.h2database<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>h2<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;version&gt;</span>1.4.200<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span></code></pre></div><h3 id="使用方法">使用方法</h3>
<ul>
<li>
<p>命名规则
<img src="/images/project-test-crawler/05.png" alt="命名规则说明"></p>
</li>
<li>
<p>目录路径
<img src="/images/project-test-crawler/06.png" alt="目录路径说明"></p>
</li>
<li>
<p>使用方法</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mvn flyway:migrate
</span></span></code></pre></div><ul>
<li>你还可以把它挂载到Maven的initialize生命周期上</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;id&gt;</span>initialize<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;phase&gt;</span>initialize<span style="color:#f92672">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;goal&gt;</span>migrate<span style="color:#f92672">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/executions&gt;</span>
</span></span></code></pre></div><h2 id="第三次重构v100">第三次重构,v1.0.0</h2>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.HttpGet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.HttpClients</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.util.EntityUtils</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.Jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Document</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Element</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.select.Elements</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.File</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.IOException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.Connection</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.DriverManager</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.PreparedStatement</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.ResultSet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.ArrayList</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.stream.Collectors</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Main</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">Connection</span> <span style="color:#111">connection</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">main</span><span style="color:#f92672">(</span><span style="color:#111">String</span><span style="color:#f92672">[]</span> <span style="color:#111">args</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span><span style="color:#f92672">,</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">setConnection</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">while</span> <span style="color:#f92672">(!</span><span style="color:#111">selectUnHandledUrls</span><span style="color:#f92672">().</span><span style="color:#75af00">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">String</span> <span style="color:#111">url</span> <span style="color:#f92672">=</span> <span style="color:#111">removeUnHandledMaxUrl</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">url</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">selectInHandledWhereUrl</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">))</span> <span style="color:#00a8c8">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">Document</span> <span style="color:#111">jsoup</span> <span style="color:#f92672">=</span> <span style="color:#111">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#f92672">(</span><span style="color:#111">jsoup</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">updateUrlWithSql</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;INSERT INTO LINKS_IN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Load links from databases
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return ArrayList
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">ArrayList</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">&gt;</span> <span style="color:#75af00">selectUnHandledUrls</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">ArrayList</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">&gt;</span> <span style="color:#111">list</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">ArrayList</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span> <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;SELECT link FROM LINKS_UN_HANDLED&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>             <span style="color:#111">ResultSet</span> <span style="color:#111">resultSet</span> <span style="color:#f92672">=</span> <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeQuery</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">while</span> <span style="color:#f92672">(</span><span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">next</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">list</span><span style="color:#f92672">.</span><span style="color:#75af00">add</span><span style="color:#f92672">(</span><span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">getString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">list</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * DELETE FROM LINKS_UN_HANDLED WHERE link = (SELECT max(id) FROM LINKS_UN_HANDLED)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return return deleted link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">String</span> <span style="color:#75af00">removeUnHandledMaxUrl</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span> <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d88200">&#34;SELECT * FROM LINKS_UN_HANDLED WHERE id=(SELECT max(id) FROM LINKS_UN_HANDLED)&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>             <span style="color:#111">ResultSet</span> <span style="color:#111">resultSet</span> <span style="color:#f92672">=</span> <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeQuery</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">next</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">String</span> <span style="color:#111">url</span> <span style="color:#f92672">=</span> <span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">getString</span><span style="color:#f92672">(</span><span style="color:#111">2</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">updateUrlWithSql</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;DELETE FROM LINKS_UN_HANDLED WHERE link = ?&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#111">url</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * SELECT link FROM LINKS_IN_HANDLED WHERE link = ?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return if exists return true, else return false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">selectInHandledWhereUrl</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;SELECT link FROM LINKS_IN_HANDLED WHERE link = ?&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">ResultSet</span> <span style="color:#111">resultSet</span> <span style="color:#f92672">=</span> <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeQuery</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">next</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * parse html to a tag, and &#39;INSERT INTO LINKS_UN_HANDLED&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return Jsoup Document
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IOException  IOException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">Document</span> <span style="color:#75af00">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">,</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Document</span> <span style="color:#111">jsoup</span> <span style="color:#f92672">=</span> <span style="color:#111">Jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">parse</span><span style="color:#f92672">(</span><span style="color:#111">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">a</span> <span style="color:#f92672">:</span> <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">String</span> <span style="color:#111">href</span> <span style="color:#f92672">=</span> <span style="color:#111">a</span><span style="color:#f92672">.</span><span style="color:#75af00">attr</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;href&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">.</span><span style="color:#75af00">toLowerCase</span><span style="color:#f92672">().</span><span style="color:#75af00">startsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;http&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">updateUrlWithSql</span><span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;INSERT INTO LINKS_UN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * executeUpdate for link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param sql  sql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateUrlWithSql</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">sql</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#111">sql</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeUpdate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get HTML content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return html body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IOException IOException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">String</span> <span style="color:#75af00">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">startsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;//&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;https:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">CloseableHttpClient</span> <span style="color:#111">document</span> <span style="color:#f92672">=</span> <span style="color:#111">HttpClients</span><span style="color:#f92672">.</span><span style="color:#75af00">createDefault</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">HttpGet</span> <span style="color:#111">request</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HttpGet</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#75af00">setHeader</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;User-Agent&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d88200">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">CloseableHttpResponse</span> <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">document</span><span style="color:#f92672">.</span><span style="color:#75af00">execute</span><span style="color:#f92672">(</span><span style="color:#111">request</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">EntityUtils</span><span style="color:#f92672">.</span><span style="color:#75af00">toString</span><span style="color:#f92672">(</span><span style="color:#111">response</span><span style="color:#f92672">.</span><span style="color:#75af00">getEntity</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Save news to database
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param jsoup Jsoup parse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#f92672">(</span><span style="color:#111">Document</span> <span style="color:#111">jsoup</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Elements</span> <span style="color:#111">articles</span> <span style="color:#f92672">=</span> <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;article&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(!</span><span style="color:#111">articles</span><span style="color:#f92672">.</span><span style="color:#75af00">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">article</span> <span style="color:#f92672">:</span> <span style="color:#111">articles</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">String</span> <span style="color:#111">title</span> <span style="color:#f92672">=</span> <span style="color:#111">article</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;h1.art_tit_h1&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#75af00">stream</span><span style="color:#f92672">().</span><span style="color:#75af00">map</span><span style="color:#f92672">(</span><span style="color:#111">Element</span><span style="color:#f92672">::</span><span style="color:#111">text</span><span style="color:#f92672">).</span><span style="color:#75af00">collect</span><span style="color:#f92672">(</span><span style="color:#111">Collectors</span><span style="color:#f92672">.</span><span style="color:#75af00">joining</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;,&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">String</span> <span style="color:#111">content</span> <span style="color:#f92672">=</span> <span style="color:#111">article</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;p.art_p&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#75af00">stream</span><span style="color:#f92672">().</span><span style="color:#75af00">map</span><span style="color:#f92672">(</span><span style="color:#111">Element</span><span style="color:#f92672">::</span><span style="color:#111">text</span><span style="color:#f92672">).</span><span style="color:#75af00">collect</span><span style="color:#f92672">(</span><span style="color:#111">Collectors</span><span style="color:#f92672">.</span><span style="color:#75af00">joining</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;\n&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span>
</span></span><span style="display:flex;"><span>                             <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;INSERT INTO NEWS(title, content, url) VALUES ( ?, ?, ? )&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">,</span> <span style="color:#111">title</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">2</span><span style="color:#f92672">,</span> <span style="color:#111">content</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">3</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeUpdate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">out</span><span style="color:#f92672">.</span><span style="color:#75af00">println</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">out</span><span style="color:#f92672">.</span><span style="color:#75af00">println</span><span style="color:#f92672">(</span><span style="color:#111">title</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the desired link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span><span style="color:#111">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#111">isNews</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the home page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;https://sina.cn&#34;</span><span style="color:#f92672">.</span><span style="color:#75af00">equals</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a login page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#f92672">!</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;passport.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a news page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;news.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Set database connection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">setConnection</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">File</span> <span style="color:#111">projectDir</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">File</span><span style="color:#f92672">(</span><span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">getProperty</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;basedir&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">getProperty</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;user.dir&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">String</span> <span style="color:#111">jdbcUrl</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;jdbc:h2:file:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#00a8c8">new</span> <span style="color:#111">File</span><span style="color:#f92672">(</span><span style="color:#111">projectDir</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;news&#34;</span><span style="color:#f92672">).</span><span style="color:#75af00">getAbsolutePath</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">connection</span> <span style="color:#f92672">=</span> <span style="color:#111">DriverManager</span><span style="color:#f92672">.</span><span style="color:#75af00">getConnection</span><span style="color:#f92672">(</span><span style="color:#111">jdbcUrl</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;root&#34;</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;toor&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="第四次重构将数据库操作剥离出去">第四次重构,将数据库操作剥离出去</h2>
<ul>
<li><code>Java</code>中对于数据库操作我们称之为<code>DAO</code>(Data Access Object)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.HttpGet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.HttpClients</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.util.EntityUtils</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.Jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Document</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Element</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.select.Elements</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.IOException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.ResultSet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.stream.Collectors</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Crawler</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">final</span> <span style="color:#111">CrawlerJdbcDao</span> <span style="color:#111">dao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#75af00">Crawler</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">this</span><span style="color:#f92672">.</span><span style="color:#75af00">dao</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">CrawlerJdbcDao</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">SQLException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">throw</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">main</span><span style="color:#f92672">(</span><span style="color:#111">String</span><span style="color:#f92672">[]</span> <span style="color:#111">args</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span><span style="color:#f92672">,</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">new</span> <span style="color:#111">Crawler</span><span style="color:#f92672">().</span><span style="color:#75af00">run</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">run</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">,</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">while</span> <span style="color:#f92672">((</span><span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#111">removeLink</span><span style="color:#f92672">())</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isHandled</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">))</span> <span style="color:#00a8c8">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">Document</span> <span style="color:#111">jsoup</span> <span style="color:#f92672">=</span> <span style="color:#111">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#f92672">(</span><span style="color:#111">jsoup</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">updateLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get a link from database and delete it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return return deleted link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#111">String</span> <span style="color:#75af00">removeLink</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">ResultSet</span> <span style="color:#111">resultSet</span> <span style="color:#f92672">=</span> <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">selectLinkFromLinksUnHandledLimit1</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">next</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">String</span> <span style="color:#111">url</span> <span style="color:#f92672">=</span> <span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">getString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#111">url</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get link is handled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return if exists return true, else return false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">ResultSet</span> <span style="color:#111">resultSet</span> <span style="color:#f92672">=</span> <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">next</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Parse html to a tag, and insert into links_un_handled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return Jsoup Document
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IOException  IOException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#111">Document</span> <span style="color:#75af00">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">,</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Document</span> <span style="color:#111">jsoup</span> <span style="color:#f92672">=</span> <span style="color:#111">Jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">parse</span><span style="color:#f92672">(</span><span style="color:#111">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">a</span> <span style="color:#f92672">:</span> <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">String</span> <span style="color:#111">href</span> <span style="color:#f92672">=</span> <span style="color:#111">a</span><span style="color:#f92672">.</span><span style="color:#75af00">attr</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;href&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">.</span><span style="color:#75af00">toLowerCase</span><span style="color:#f92672">().</span><span style="color:#75af00">startsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;http&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">updateLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get HTML content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return html body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IOException IOException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">String</span> <span style="color:#75af00">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">startsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;//&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;https:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">CloseableHttpClient</span> <span style="color:#111">document</span> <span style="color:#f92672">=</span> <span style="color:#111">HttpClients</span><span style="color:#f92672">.</span><span style="color:#75af00">createDefault</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">HttpGet</span> <span style="color:#111">request</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HttpGet</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#75af00">setHeader</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;User-Agent&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d88200">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">CloseableHttpResponse</span> <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">document</span><span style="color:#f92672">.</span><span style="color:#75af00">execute</span><span style="color:#f92672">(</span><span style="color:#111">request</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">EntityUtils</span><span style="color:#f92672">.</span><span style="color:#75af00">toString</span><span style="color:#f92672">(</span><span style="color:#111">response</span><span style="color:#f92672">.</span><span style="color:#75af00">getEntity</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Save news to database
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param jsoup Jsoup parse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#f92672">(</span><span style="color:#111">Document</span> <span style="color:#111">jsoup</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Elements</span> <span style="color:#111">articles</span> <span style="color:#f92672">=</span> <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;article&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(!</span><span style="color:#111">articles</span><span style="color:#f92672">.</span><span style="color:#75af00">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">article</span> <span style="color:#f92672">:</span> <span style="color:#111">articles</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">String</span> <span style="color:#111">title</span> <span style="color:#f92672">=</span> <span style="color:#111">article</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;h1.art_tit_h1&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#75af00">stream</span><span style="color:#f92672">().</span><span style="color:#75af00">map</span><span style="color:#f92672">(</span><span style="color:#111">Element</span><span style="color:#f92672">::</span><span style="color:#111">text</span><span style="color:#f92672">).</span><span style="color:#75af00">collect</span><span style="color:#f92672">(</span><span style="color:#111">Collectors</span><span style="color:#f92672">.</span><span style="color:#75af00">joining</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;,&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">String</span> <span style="color:#111">content</span> <span style="color:#f92672">=</span> <span style="color:#111">article</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;p.art_p&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#75af00">stream</span><span style="color:#f92672">().</span><span style="color:#75af00">map</span><span style="color:#f92672">(</span><span style="color:#111">Element</span><span style="color:#f92672">::</span><span style="color:#111">text</span><span style="color:#f92672">).</span><span style="color:#75af00">collect</span><span style="color:#f92672">(</span><span style="color:#111">Collectors</span><span style="color:#f92672">.</span><span style="color:#75af00">joining</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;\n&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">updateNews</span><span style="color:#f92672">(</span><span style="color:#111">title</span><span style="color:#f92672">,</span> <span style="color:#111">content</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">out</span><span style="color:#f92672">.</span><span style="color:#75af00">println</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">out</span><span style="color:#f92672">.</span><span style="color:#75af00">println</span><span style="color:#f92672">(</span><span style="color:#111">title</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the desired link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span><span style="color:#111">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#111">isNews</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the home page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;https://sina.cn&#34;</span><span style="color:#f92672">.</span><span style="color:#75af00">equals</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a login page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#f92672">!</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;passport.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a news page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;news.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>DAO Interface</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.ResultSet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">interface</span> <span style="color:#75af00">CrawlerDao</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">title</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">content</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">ResultSet</span> <span style="color:#75af00">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">ResultSet</span> <span style="color:#75af00">selectLinkFromLinksUnHandledLimit1</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>CrawlerJdbcDao</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.File</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.Connection</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.DriverManager</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.PreparedStatement</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.ResultSet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">CrawlerJdbcDao</span> <span style="color:#00a8c8">implements</span> <span style="color:#111">CrawlerDao</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">Connection</span> <span style="color:#111">connection</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#75af00">CrawlerJdbcDao</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">setConnection</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Delete link from LINKS_UN_HANDLED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;DELETE FROM LINKS_UN_HANDLED WHERE link = ?&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Insert into link to LINKS_UN_HANDLED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;INSERT INTO LINKS_UN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Insert into link to LINKS_IN_HANDLED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;INSERT INTO LINKS_IN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Insert into news
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param title   news title
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param content news content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url     news url
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">title</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">content</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;INSERT INTO NEWS(title, content, url) VALUES ( ?, ?, ? )&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">,</span> <span style="color:#111">title</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">2</span><span style="color:#f92672">,</span> <span style="color:#111">content</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">3</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeUpdate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get link from LINKS_IN_HANDLED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return ResultSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#111">ResultSet</span> <span style="color:#75af00">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">queryLink</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;SELECT link FROM LINKS_IN_HANDLED WHERE link = ?&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get a link from LINKS_UN_HANDLED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return ResutSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#111">ResultSet</span> <span style="color:#75af00">selectLinkFromLinksUnHandledLimit1</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">query</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;SELECT link FROM LINKS_UN_HANDLED LIMIT 1&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Execute query
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param sql sql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return ResultSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#111">ResultSet</span> <span style="color:#75af00">query</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">sql</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#111">sql</span><span style="color:#f92672">).</span><span style="color:#75af00">executeQuery</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Execute query for link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param sql  sql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return ResultSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#111">ResultSet</span> <span style="color:#75af00">queryLink</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">sql</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span> <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#111">sql</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeQuery</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Update link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param sql  sql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLink</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">sql</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span> <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#111">sql</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeUpdate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Set database connection
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">setConnection</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">File</span> <span style="color:#111">projectDir</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">File</span><span style="color:#f92672">(</span><span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">getProperty</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;basedir&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">getProperty</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;user.dir&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">String</span> <span style="color:#111">jdbcUrl</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;jdbc:h2:file:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#00a8c8">new</span> <span style="color:#111">File</span><span style="color:#f92672">(</span><span style="color:#111">projectDir</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;news&#34;</span><span style="color:#f92672">).</span><span style="color:#75af00">getAbsolutePath</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">connection</span> <span style="color:#f92672">=</span> <span style="color:#111">DriverManager</span><span style="color:#f92672">.</span><span style="color:#75af00">getConnection</span><span style="color:#f92672">(</span><span style="color:#111">jdbcUrl</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;root&#34;</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;toor&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="第五次重构引入ormobjectrelational-mapping对象关系映射">第五次重构,引入ORM(Object–relational mapping)对象关系映射</h2>
<p>ORM主要作用就是简化你的数据库操作</p>
<ul>
<li>src/main/resources/db/mybatis/mybatis-config.xml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE configuration
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        PUBLIC &#34;-//mybatis.org//DTD Config 3.0//EN&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        &#34;http://mybatis.org/dtd/mybatis-3-config.dtd&#34;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;environments</span> <span style="color:#75af00">default=</span><span style="color:#d88200">&#34;development&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;environment</span> <span style="color:#75af00">id=</span><span style="color:#d88200">&#34;development&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;transactionManager</span> <span style="color:#75af00">type=</span><span style="color:#d88200">&#34;JDBC&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;dataSource</span> <span style="color:#75af00">type=</span><span style="color:#d88200">&#34;POOLED&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;property</span> <span style="color:#75af00">name=</span><span style="color:#d88200">&#34;driver&#34;</span> <span style="color:#75af00">value=</span><span style="color:#d88200">&#34;org.h2.Driver&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;property</span> <span style="color:#75af00">name=</span><span style="color:#d88200">&#34;url&#34;</span> <span style="color:#75af00">value=</span><span style="color:#d88200">&#34;jdbc:h2:file:./news&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;property</span> <span style="color:#75af00">name=</span><span style="color:#d88200">&#34;username&#34;</span> <span style="color:#75af00">value=</span><span style="color:#d88200">&#34;root&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;property</span> <span style="color:#75af00">name=</span><span style="color:#d88200">&#34;password&#34;</span> <span style="color:#75af00">value=</span><span style="color:#d88200">&#34;toor&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/dataSource&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/environment&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/environments&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;mappers&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;mapper</span> <span style="color:#75af00">resource=</span><span style="color:#d88200">&#34;db/mybatis/crawler-mapper.xml&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/mappers&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/configuration&gt;</span>
</span></span></code></pre></div><ul>
<li>src/main/resources/db/mybatis/crawler-mapper.xml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!DOCTYPE mapper
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        PUBLIC &#34;-//mybatis.org//DTD Mapper 3.0//EN&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        &#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;mapper</span> <span style="color:#75af00">namespace=</span><span style="color:#d88200">&#34;com.github.wjinlei.mybatis&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;delete</span> <span style="color:#75af00">id=</span><span style="color:#d88200">&#34;deleteFromLinksUnHandledWhereLinkIs&#34;</span> <span style="color:#75af00">parameterType=</span><span style="color:#d88200">&#34;String&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        DELETE
</span></span><span style="display:flex;"><span>        FROM LINKS_UN_HANDLED
</span></span><span style="display:flex;"><span>        WHERE link = #{link}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/delete&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;update</span> <span style="color:#75af00">id=</span><span style="color:#d88200">&#34;updateLinksUnHandled&#34;</span> <span style="color:#75af00">parameterType=</span><span style="color:#d88200">&#34;HashMap&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        INSERT INTO
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;choose&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;when</span> <span style="color:#75af00">test=</span><span style="color:#d88200">&#34;table_name == &#39;LINKS_IN_HANDLED&#39;&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>                LINKS_IN_HANDLED
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/when&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;otherwise&gt;</span>
</span></span><span style="display:flex;"><span>                LINKS_UN_HANDLED
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/otherwise&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/choose&gt;</span>
</span></span><span style="display:flex;"><span>        (link)
</span></span><span style="display:flex;"><span>        VALUES (#{link})
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/update&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;update</span> <span style="color:#75af00">id=</span><span style="color:#d88200">&#34;updateNews&#34;</span> <span style="color:#75af00">parameterType=</span><span style="color:#d88200">&#34;String&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        INSERT INTO NEWS(title, content, url)
</span></span><span style="display:flex;"><span>        VALUES (#{title}, #{content}, #{url})
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/update&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;select</span> <span style="color:#75af00">id=</span><span style="color:#d88200">&#34;selectLinkFromLinksInHandledWhereLinkIs&#34;</span> <span style="color:#75af00">parameterType=</span><span style="color:#d88200">&#34;String&#34;</span> <span style="color:#75af00">resultType=</span><span style="color:#d88200">&#34;boolean&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        SELECT count(link)
</span></span><span style="display:flex;"><span>        FROM LINKS_IN_HANDLED
</span></span><span style="display:flex;"><span>        WHERE link = #{url}
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/select&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;select</span> <span style="color:#75af00">id=</span><span style="color:#d88200">&#34;selectLinkFromLinksUnHandledLimit1&#34;</span> <span style="color:#75af00">resultType=</span><span style="color:#d88200">&#34;String&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        SELECT link
</span></span><span style="display:flex;"><span>        FROM LINKS_UN_HANDLED
</span></span><span style="display:flex;"><span>        LIMIT 1
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/select&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/mapper&gt;</span>
</span></span></code></pre></div><ul>
<li>src/main/java/com/github/wjinlei/dao/CrawlerDao.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#111">com.github.wjinlei.dao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">interface</span> <span style="color:#75af00">CrawlerDao</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">title</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">content</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">String</span> <span style="color:#75af00">selectLinkFromLinksUnHandledLimit1</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>src/main/java/com/github/wjinlei/dao/CrawlerMybatisDao.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#111">com.github.wjinlei.dao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.ibatis.io.Resources</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.ibatis.session.SqlSession</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.ibatis.session.SqlSessionFactory</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.ibatis.session.SqlSessionFactoryBuilder</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.IOException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.InputStream</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.HashMap</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">CrawlerMybatisDao</span> <span style="color:#00a8c8">implements</span> <span style="color:#111">CrawlerDao</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">final</span> <span style="color:#111">SqlSessionFactory</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">final</span> <span style="color:#111">String</span> <span style="color:#111">NAMESPACE</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;com.github.wjinlei.mybatis&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#75af00">CrawlerMybatisDao</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">String</span> <span style="color:#111">resource</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;db/mybatis/mybatis-config.xml&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">InputStream</span> <span style="color:#111">inputStream</span> <span style="color:#f92672">=</span> <span style="color:#111">Resources</span><span style="color:#f92672">.</span><span style="color:#75af00">getResourceAsStream</span><span style="color:#f92672">(</span><span style="color:#111">resource</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">sqlSessionFactory</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">SqlSessionFactoryBuilder</span><span style="color:#f92672">().</span><span style="color:#75af00">build</span><span style="color:#f92672">(</span><span style="color:#111">inputStream</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">IOException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">throw</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">SqlSession</span> <span style="color:#111">sqlSession</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">.</span><span style="color:#75af00">openSession</span><span style="color:#f92672">(</span><span style="color:#00a8c8">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">sqlSession</span><span style="color:#f92672">.</span><span style="color:#75af00">delete</span><span style="color:#f92672">(</span><span style="color:#111">NAMESPACE</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;.deleteFromLinksUnHandledWhereLinkIs&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;LINKS_UN_HANDLED&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;LINKS_IN_HANDLED&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">title</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">content</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">SqlSession</span> <span style="color:#111">sqlSession</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">.</span><span style="color:#75af00">openSession</span><span style="color:#f92672">(</span><span style="color:#00a8c8">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">HashMap</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">,</span> <span style="color:#111">Object</span><span style="color:#f92672">&gt;</span> <span style="color:#111">hashMap</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HashMap</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">hashMap</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;title&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">title</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">hashMap</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;content&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">content</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">hashMap</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">sqlSession</span><span style="color:#f92672">.</span><span style="color:#75af00">update</span><span style="color:#f92672">(</span><span style="color:#111">NAMESPACE</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;.updateNews&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">hashMap</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">SqlSession</span> <span style="color:#111">sqlSession</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">.</span><span style="color:#75af00">openSession</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">Object</span> <span style="color:#111">result</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSession</span><span style="color:#f92672">.</span><span style="color:#75af00">selectOne</span><span style="color:#f92672">(</span><span style="color:#111">NAMESPACE</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;.selectLinkFromLinksInHandledWhereLinkIs&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">result</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#f92672">(</span><span style="color:#00a8c8">boolean</span><span style="color:#f92672">)</span> <span style="color:#111">result</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#111">String</span> <span style="color:#75af00">selectLinkFromLinksUnHandledLimit1</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">SqlSession</span> <span style="color:#111">sqlSession</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">.</span><span style="color:#75af00">openSession</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">sqlSession</span><span style="color:#f92672">.</span><span style="color:#75af00">selectOne</span><span style="color:#f92672">(</span><span style="color:#111">NAMESPACE</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;.selectLinkFromLinksUnHandledLimit1&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLink</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">links_un_handled</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">SqlSession</span> <span style="color:#111">sqlSession</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">.</span><span style="color:#75af00">openSession</span><span style="color:#f92672">(</span><span style="color:#00a8c8">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">HashMap</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">,</span> <span style="color:#111">Object</span><span style="color:#f92672">&gt;</span> <span style="color:#111">hashMap</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HashMap</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">hashMap</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;table_name&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">links_un_handled</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">hashMap</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;link&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">sqlSession</span><span style="color:#f92672">.</span><span style="color:#75af00">update</span><span style="color:#f92672">(</span><span style="color:#111">NAMESPACE</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;.updateLinksUnHandled&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">hashMap</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>src/main/java/com/github/wjinlei/dao/CrawlerJdbcDao.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#111">com.github.wjinlei.dao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.File</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.Connection</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.DriverManager</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.PreparedStatement</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.ResultSet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">CrawlerJdbcDao</span> <span style="color:#00a8c8">implements</span> <span style="color:#111">CrawlerDao</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">Connection</span> <span style="color:#111">connection</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#75af00">CrawlerJdbcDao</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">File</span> <span style="color:#111">projectDir</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">File</span><span style="color:#f92672">(</span><span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">getProperty</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;basedir&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">getProperty</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;user.dir&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">String</span> <span style="color:#111">jdbcUrl</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;jdbc:h2:file:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#00a8c8">new</span> <span style="color:#111">File</span><span style="color:#f92672">(</span><span style="color:#111">projectDir</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;news&#34;</span><span style="color:#f92672">).</span><span style="color:#75af00">getAbsolutePath</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">connection</span> <span style="color:#f92672">=</span> <span style="color:#111">DriverManager</span><span style="color:#f92672">.</span><span style="color:#75af00">getConnection</span><span style="color:#f92672">(</span><span style="color:#111">jdbcUrl</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;root&#34;</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;toor&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">SQLException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">throw</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Delete link from LINKS_UN_HANDLED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;DELETE FROM LINKS_UN_HANDLED WHERE link = ?&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Insert into link to LINKS_UN_HANDLED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;INSERT INTO LINKS_UN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Insert into link to LINKS_IN_HANDLED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;INSERT INTO LINKS_IN_HANDLED(link) VALUES ( ? )&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Insert into news
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param title   news title
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param content news content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url     news url
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">title</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">content</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;INSERT INTO NEWS(title, content, url) VALUES ( ?, ?, ? )&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">,</span> <span style="color:#111">title</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">2</span><span style="color:#f92672">,</span> <span style="color:#111">content</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">3</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeUpdate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get link from LINKS_IN_HANDLED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return ResultSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">ResultSet</span> <span style="color:#111">resultSet</span> <span style="color:#f92672">=</span> <span style="color:#111">queryLink</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;SELECT link FROM LINKS_IN_HANDLED WHERE link = ?&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">next</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get a link from LINKS_UN_HANDLED
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return ResutSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#111">String</span> <span style="color:#75af00">selectLinkFromLinksUnHandledLimit1</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">ResultSet</span> <span style="color:#111">resultSet</span> <span style="color:#f92672">=</span> <span style="color:#111">query</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;SELECT link FROM LINKS_UN_HANDLED LIMIT 1&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">next</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#111">resultSet</span><span style="color:#f92672">.</span><span style="color:#75af00">getString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Execute query
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param sql sql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return ResultSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#111">ResultSet</span> <span style="color:#75af00">query</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">sql</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#111">sql</span><span style="color:#f92672">).</span><span style="color:#75af00">executeQuery</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Execute query for link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param sql  sql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return ResultSet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#111">ResultSet</span> <span style="color:#75af00">queryLink</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">sql</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span> <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#111">sql</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeQuery</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Update link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param sql  sql
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLink</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">sql</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">PreparedStatement</span> <span style="color:#111">preparedStatement</span> <span style="color:#f92672">=</span> <span style="color:#111">connection</span><span style="color:#f92672">.</span><span style="color:#75af00">prepareStatement</span><span style="color:#f92672">(</span><span style="color:#111">sql</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">setString</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">preparedStatement</span><span style="color:#f92672">.</span><span style="color:#75af00">executeUpdate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>src/main/java/com/github/wjinlei/Crawler.java</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#111">com.github.wjinlei</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">com.github.wjinlei.dao.CrawlerDao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">com.github.wjinlei.dao.CrawlerMybatisDao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.HttpGet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.HttpClients</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.util.EntityUtils</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.Jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Document</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Element</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.select.Elements</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.IOException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.stream.Collectors</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Crawler</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">final</span> <span style="color:#111">CrawlerDao</span> <span style="color:#111">dao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#75af00">Crawler</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">this</span><span style="color:#f92672">.</span><span style="color:#75af00">dao</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">CrawlerMybatisDao</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">main</span><span style="color:#f92672">(</span><span style="color:#111">String</span><span style="color:#f92672">[]</span> <span style="color:#111">args</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span><span style="color:#f92672">,</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">new</span> <span style="color:#111">Crawler</span><span style="color:#f92672">().</span><span style="color:#75af00">run</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">run</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">,</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">while</span> <span style="color:#f92672">((</span><span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#111">removeLink</span><span style="color:#f92672">())</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isHandled</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">))</span> <span style="color:#00a8c8">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">Document</span> <span style="color:#111">jsoup</span> <span style="color:#f92672">=</span> <span style="color:#111">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#f92672">(</span><span style="color:#111">jsoup</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">updateLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get a link from database and delete it
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return return deleted link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#111">String</span> <span style="color:#75af00">removeLink</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">String</span> <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">selectLinkFromLinksUnHandledLimit1</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">link</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">deleteFromLinksUnHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get link is handled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return if exists return true, else return false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">selectLinkFromLinksInHandledWhereLinkIs</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Parse html to a tag, and insert into links_un_handled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return Jsoup Document
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IOException  IOException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#111">Document</span> <span style="color:#75af00">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">,</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Document</span> <span style="color:#111">jsoup</span> <span style="color:#f92672">=</span> <span style="color:#111">Jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">parse</span><span style="color:#f92672">(</span><span style="color:#111">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">a</span> <span style="color:#f92672">:</span> <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">String</span> <span style="color:#111">href</span> <span style="color:#f92672">=</span> <span style="color:#111">a</span><span style="color:#f92672">.</span><span style="color:#75af00">attr</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;href&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">.</span><span style="color:#75af00">toLowerCase</span><span style="color:#f92672">().</span><span style="color:#75af00">startsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;http&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">updateLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get HTML content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return html body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IOException IOException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">String</span> <span style="color:#75af00">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">startsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;//&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;https:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">CloseableHttpClient</span> <span style="color:#111">document</span> <span style="color:#f92672">=</span> <span style="color:#111">HttpClients</span><span style="color:#f92672">.</span><span style="color:#75af00">createDefault</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">HttpGet</span> <span style="color:#111">request</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HttpGet</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#75af00">setHeader</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;User-Agent&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d88200">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">CloseableHttpResponse</span> <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">document</span><span style="color:#f92672">.</span><span style="color:#75af00">execute</span><span style="color:#f92672">(</span><span style="color:#111">request</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">EntityUtils</span><span style="color:#f92672">.</span><span style="color:#75af00">toString</span><span style="color:#f92672">(</span><span style="color:#111">response</span><span style="color:#f92672">.</span><span style="color:#75af00">getEntity</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Save news to database
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param jsoup Jsoup parse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#f92672">(</span><span style="color:#111">Document</span> <span style="color:#111">jsoup</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Elements</span> <span style="color:#111">articles</span> <span style="color:#f92672">=</span> <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;article&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(!</span><span style="color:#111">articles</span><span style="color:#f92672">.</span><span style="color:#75af00">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">article</span> <span style="color:#f92672">:</span> <span style="color:#111">articles</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">String</span> <span style="color:#111">title</span> <span style="color:#f92672">=</span> <span style="color:#111">article</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;h1.art_tit_h1&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#75af00">stream</span><span style="color:#f92672">().</span><span style="color:#75af00">map</span><span style="color:#f92672">(</span><span style="color:#111">Element</span><span style="color:#f92672">::</span><span style="color:#111">text</span><span style="color:#f92672">).</span><span style="color:#75af00">collect</span><span style="color:#f92672">(</span><span style="color:#111">Collectors</span><span style="color:#f92672">.</span><span style="color:#75af00">joining</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;,&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">String</span> <span style="color:#111">content</span> <span style="color:#f92672">=</span> <span style="color:#111">article</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;p.art_p&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#75af00">stream</span><span style="color:#f92672">().</span><span style="color:#75af00">map</span><span style="color:#f92672">(</span><span style="color:#111">Element</span><span style="color:#f92672">::</span><span style="color:#111">text</span><span style="color:#f92672">).</span><span style="color:#75af00">collect</span><span style="color:#f92672">(</span><span style="color:#111">Collectors</span><span style="color:#f92672">.</span><span style="color:#75af00">joining</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;\n&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">updateNews</span><span style="color:#f92672">(</span><span style="color:#111">title</span><span style="color:#f92672">,</span> <span style="color:#111">content</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">out</span><span style="color:#f92672">.</span><span style="color:#75af00">println</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">out</span><span style="color:#f92672">.</span><span style="color:#75af00">println</span><span style="color:#f92672">(</span><span style="color:#111">title</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the desired link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span><span style="color:#111">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#111">isNews</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the home page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;https://sina.cn&#34;</span><span style="color:#f92672">.</span><span style="color:#75af00">equals</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a login page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#f92672">!</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;passport.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a news page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;news.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="迁移到mysql">迁移到MySQL</h2>
<ol>
<li>添加MySQL JDBC驱动</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>mysql<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>mysql-connector-java<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>8.0.27<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>修改flyway连接配置</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;url&gt;</span>jdbc:mysql://localhost:3306/news?characterEncoding=utf-8<span style="color:#f92672">&lt;/url&gt;</span>
</span></span></code></pre></div><ol start="3">
<li>修改Mybatis的驱动和连接配置</li>
</ol>
<ul>
<li>值得注意的是新版的jdbc驱动class是<code>com.mysql.cj.jdbc.Driver</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dataSource&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;property</span> <span style="color:#75af00">name=</span><span style="color:#d88200">&#34;driver&#34;</span> <span style="color:#75af00">value=</span><span style="color:#d88200">&#34;com.mysql.jdbc.Driver&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;property</span> <span style="color:#75af00">name=</span><span style="color:#d88200">&#34;url&#34;</span> <span style="color:#75af00">value=</span><span style="color:#d88200">&#34;jdbc:mysql://localhost:3306/news?characterEncoding=utf-8&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;property</span> <span style="color:#75af00">name=</span><span style="color:#d88200">&#34;username&#34;</span> <span style="color:#75af00">value=</span><span style="color:#d88200">&#34;root&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;property</span> <span style="color:#75af00">name=</span><span style="color:#d88200">&#34;password&#34;</span> <span style="color:#75af00">value=</span><span style="color:#d88200">&#34;toor&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dataSource&gt;</span>
</span></span></code></pre></div><ol start="4">
<li>在MySQL中创建<code>news</code>数据库,并指定<code>utf8mb4</code>编码
<ul>
<li>注意MySQL帐号是<code>root</code>密码是<code>toor</code></li>
</ul>
</li>
</ol>
<h2 id="第六次重构改造多线程提升爬虫性能">第六次重构,改造多线程提升爬虫性能</h2>
<ul>
<li>Crawler类继承Thread并覆盖run方法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">com.github.wjinlei.dao.CrawlerDao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.CloseableHttpResponse</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.client.methods.HttpGet</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.CloseableHttpClient</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.impl.client.HttpClients</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.util.EntityUtils</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.Jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Document</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.nodes.Element</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.jsoup.select.Elements</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.IOException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.stream.Collectors</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Crawler</span> <span style="color:#00a8c8">extends</span> <span style="color:#111">Thread</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">final</span> <span style="color:#111">CrawlerDao</span> <span style="color:#111">dao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#75af00">Crawler</span><span style="color:#f92672">(</span><span style="color:#111">CrawlerDao</span> <span style="color:#111">dao</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">this</span><span style="color:#f92672">.</span><span style="color:#75af00">dao</span> <span style="color:#f92672">=</span> <span style="color:#111">dao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">while</span> <span style="color:#f92672">((</span><span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">removeLinksUnHandled</span><span style="color:#f92672">())</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">selectLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">))</span> <span style="color:#00a8c8">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">Document</span> <span style="color:#111">jsoup</span> <span style="color:#f92672">=</span> <span style="color:#111">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#f92672">(</span><span style="color:#111">jsoup</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">updateLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">IOException</span> <span style="color:#f92672">|</span> <span style="color:#111">SQLException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">throw</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Parse html to a tag, and insert into links_un_handled
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param url http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return Jsoup Document
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws SQLException SQLException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IOException  IOException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#111">Document</span> <span style="color:#75af00">parseHtmlToHrefAndInsertIntoLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">,</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Document</span> <span style="color:#111">jsoup</span> <span style="color:#f92672">=</span> <span style="color:#111">Jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">parse</span><span style="color:#f92672">(</span><span style="color:#111">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">a</span> <span style="color:#f92672">:</span> <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;a&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">String</span> <span style="color:#111">href</span> <span style="color:#f92672">=</span> <span style="color:#111">a</span><span style="color:#f92672">.</span><span style="color:#75af00">attr</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;href&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">.</span><span style="color:#75af00">toLowerCase</span><span style="color:#f92672">().</span><span style="color:#75af00">startsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;http&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">updateLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">href</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">jsoup</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Get HTML content
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return html body
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws IOException IOException
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#111">String</span> <span style="color:#75af00">httpGetHTML</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">IOException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">startsWith</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;//&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;https:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">CloseableHttpClient</span> <span style="color:#111">document</span> <span style="color:#f92672">=</span> <span style="color:#111">HttpClients</span><span style="color:#f92672">.</span><span style="color:#75af00">createDefault</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">HttpGet</span> <span style="color:#111">request</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HttpGet</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">request</span><span style="color:#f92672">.</span><span style="color:#75af00">setHeader</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;User-Agent&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#d88200">&#34;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/95.0.4638.69 Safari/537.36&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">CloseableHttpResponse</span> <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">document</span><span style="color:#f92672">.</span><span style="color:#75af00">execute</span><span style="color:#f92672">(</span><span style="color:#111">request</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">EntityUtils</span><span style="color:#f92672">.</span><span style="color:#75af00">toString</span><span style="color:#f92672">(</span><span style="color:#111">response</span><span style="color:#f92672">.</span><span style="color:#75af00">getEntity</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Save news to database
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param jsoup Jsoup parse
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">jsoupCssSelectAirtcleAndParseToInsertIntoNews</span><span style="color:#f92672">(</span><span style="color:#111">Document</span> <span style="color:#111">jsoup</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Elements</span> <span style="color:#111">articles</span> <span style="color:#f92672">=</span> <span style="color:#111">jsoup</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;article&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">if</span> <span style="color:#f92672">(!</span><span style="color:#111">articles</span><span style="color:#f92672">.</span><span style="color:#75af00">isEmpty</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#111">Element</span> <span style="color:#111">article</span> <span style="color:#f92672">:</span> <span style="color:#111">articles</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">String</span> <span style="color:#111">title</span> <span style="color:#f92672">=</span> <span style="color:#111">article</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;h1.art_tit_h1&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#75af00">stream</span><span style="color:#f92672">().</span><span style="color:#75af00">map</span><span style="color:#f92672">(</span><span style="color:#111">Element</span><span style="color:#f92672">::</span><span style="color:#111">text</span><span style="color:#f92672">).</span><span style="color:#75af00">collect</span><span style="color:#f92672">(</span><span style="color:#111">Collectors</span><span style="color:#f92672">.</span><span style="color:#75af00">joining</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;,&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">String</span> <span style="color:#111">content</span> <span style="color:#f92672">=</span> <span style="color:#111">article</span><span style="color:#f92672">.</span><span style="color:#75af00">select</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;p.art_p&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">.</span><span style="color:#75af00">stream</span><span style="color:#f92672">().</span><span style="color:#75af00">map</span><span style="color:#f92672">(</span><span style="color:#111">Element</span><span style="color:#f92672">::</span><span style="color:#111">text</span><span style="color:#f92672">).</span><span style="color:#75af00">collect</span><span style="color:#f92672">(</span><span style="color:#111">Collectors</span><span style="color:#f92672">.</span><span style="color:#75af00">joining</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;\n&#34;</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">dao</span><span style="color:#f92672">.</span><span style="color:#75af00">updateNews</span><span style="color:#f92672">(</span><span style="color:#111">title</span><span style="color:#f92672">,</span> <span style="color:#111">content</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">out</span><span style="color:#f92672">.</span><span style="color:#75af00">println</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">System</span><span style="color:#f92672">.</span><span style="color:#75af00">out</span><span style="color:#f92672">.</span><span style="color:#75af00">println</span><span style="color:#f92672">(</span><span style="color:#111">title</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the desired link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isWantTo</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span><span style="color:#111">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#111">isNews</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is the home page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isIndex</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#d88200">&#34;https://sina.cn&#34;</span><span style="color:#f92672">.</span><span style="color:#75af00">equals</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a login page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNotLogin</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#f92672">!</span><span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;passport.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * Determine whether it is a news page
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param link http or https link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return true or false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">isNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#111">link</span><span style="color:#f92672">.</span><span style="color:#75af00">contains</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;news.sina.cn&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>抽取成单独的Main类</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#111">com.github.wjinlei</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">com.github.wjinlei.dao.CrawlerMybatisDao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">Main</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">main</span><span style="color:#f92672">(</span><span style="color:#111">String</span><span style="color:#f92672">[]</span> <span style="color:#111">args</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">CrawlerMybatisDao</span> <span style="color:#111">crawlerMybatisDao</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">CrawlerMybatisDao</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">for</span> <span style="color:#f92672">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">i</span> <span style="color:#f92672">=</span> <span style="color:#111">0</span><span style="color:#f92672">;</span> <span style="color:#111">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#111">16</span><span style="color:#f92672">;</span> <span style="color:#111">i</span><span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">new</span> <span style="color:#111">Crawler</span><span style="color:#f92672">(</span><span style="color:#111">crawlerMybatisDao</span><span style="color:#f92672">).</span><span style="color:#75af00">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>优化DAO接口</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#111">com.github.wjinlei.dao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.sql.SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">interface</span> <span style="color:#75af00">CrawlerDao</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">deleteLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">title</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">content</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">selectLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">String</span> <span style="color:#75af00">removeLinksUnHandled</span><span style="color:#f92672">()</span> <span style="color:#00a8c8">throws</span> <span style="color:#111">SQLException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><ul>
<li>MybatisDao,同步关键函数,避免一个连接被处理多次</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.ibatis.io.Resources</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.ibatis.session.SqlSession</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.ibatis.session.SqlSessionFactory</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.ibatis.session.SqlSessionFactoryBuilder</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.IOException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.InputStream</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.HashMap</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">CrawlerMybatisDao</span> <span style="color:#00a8c8">implements</span> <span style="color:#111">CrawlerDao</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">final</span> <span style="color:#111">SqlSessionFactory</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">final</span> <span style="color:#111">String</span> <span style="color:#111">NAMESPACE</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;com.github.wjinlei.mybatis&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#75af00">CrawlerMybatisDao</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">String</span> <span style="color:#111">resource</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;db/mybatis/mybatis-config.xml&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">InputStream</span> <span style="color:#111">inputStream</span> <span style="color:#f92672">=</span> <span style="color:#111">Resources</span><span style="color:#f92672">.</span><span style="color:#75af00">getResourceAsStream</span><span style="color:#f92672">(</span><span style="color:#111">resource</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">sqlSessionFactory</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">SqlSessionFactoryBuilder</span><span style="color:#f92672">().</span><span style="color:#75af00">build</span><span style="color:#f92672">(</span><span style="color:#111">inputStream</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">IOException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">throw</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">deleteLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">SqlSession</span> <span style="color:#111">sqlSession</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">.</span><span style="color:#75af00">openSession</span><span style="color:#f92672">(</span><span style="color:#00a8c8">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">sqlSession</span><span style="color:#f92672">.</span><span style="color:#75af00">delete</span><span style="color:#f92672">(</span><span style="color:#111">NAMESPACE</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;.deleteFromLinksUnHandledWhereLinkIs&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;LINKS_UN_HANDLED&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;LINKS_IN_HANDLED&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">title</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">content</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">SqlSession</span> <span style="color:#111">sqlSession</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">.</span><span style="color:#75af00">openSession</span><span style="color:#f92672">(</span><span style="color:#00a8c8">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">HashMap</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">,</span> <span style="color:#111">Object</span><span style="color:#f92672">&gt;</span> <span style="color:#111">hashMap</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HashMap</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">hashMap</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;title&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">title</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">hashMap</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;content&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">content</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">hashMap</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">sqlSession</span><span style="color:#f92672">.</span><span style="color:#75af00">update</span><span style="color:#f92672">(</span><span style="color:#111">NAMESPACE</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;.updateNews&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">hashMap</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">selectLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">SqlSession</span> <span style="color:#111">sqlSession</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">.</span><span style="color:#75af00">openSession</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">Object</span> <span style="color:#111">result</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSession</span><span style="color:#f92672">.</span><span style="color:#75af00">selectOne</span><span style="color:#f92672">(</span><span style="color:#111">NAMESPACE</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;.selectLinkFromLinksInHandledWhereLinkIs&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">result</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#f92672">(</span><span style="color:#00a8c8">boolean</span><span style="color:#f92672">)</span> <span style="color:#111">result</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">synchronized</span> <span style="color:#111">String</span> <span style="color:#75af00">removeLinksUnHandled</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">SqlSession</span> <span style="color:#111">sqlSession</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">.</span><span style="color:#75af00">openSession</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">String</span> <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSession</span><span style="color:#f92672">.</span><span style="color:#75af00">selectOne</span><span style="color:#f92672">(</span><span style="color:#111">NAMESPACE</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;.selectLinkFromLinksUnHandledLimit1&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">link</span> <span style="color:#f92672">!=</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">deleteLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">return</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLink</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">links_un_handled</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">SqlSession</span> <span style="color:#111">sqlSession</span> <span style="color:#f92672">=</span> <span style="color:#111">sqlSessionFactory</span><span style="color:#f92672">.</span><span style="color:#75af00">openSession</span><span style="color:#f92672">(</span><span style="color:#00a8c8">true</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">HashMap</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">,</span> <span style="color:#111">Object</span><span style="color:#f92672">&gt;</span> <span style="color:#111">hashMap</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HashMap</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">hashMap</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;table_name&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">links_un_handled</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">hashMap</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;link&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">sqlSession</span><span style="color:#f92672">.</span><span style="color:#75af00">update</span><span style="color:#f92672">(</span><span style="color:#111">NAMESPACE</span> <span style="color:#f92672">+</span> <span style="color:#d88200">&#34;.updateLinksUnHandled&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">hashMap</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="引入elasticsearch">引入Elasticsearch</h2>
<ul>
<li>Elasticsearch的主要能力是搜索,你可以把它理解为是一个数据库,它对于<code>文本</code>的检索能力是最强的</li>
<li>可参考 <a href="https://www.elastic.co/guide/cn/elasticsearch/guide/2.x/index.html">Elasticsearch 权威指南</a></li>
<li><code>Index</code>和传统数据库的<code>表</code>对应</li>
<li><code>Document</code>和传统数据库的<code>行(row)</code>对应</li>
<li><code>Field</code>和传统数据库的<code>列(Column)</code>对应</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#111">com.github.wjinlei.dao</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.apache.http.HttpHost</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.action.delete.DeleteRequest</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.action.get.GetRequest</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.action.get.GetResponse</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.action.index.IndexRequest</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.action.search.SearchRequest</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.action.search.SearchResponse</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.client.RequestOptions</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.client.RestClient</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.client.RestHighLevelClient</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.client.indices.CreateIndexRequest</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.client.indices.GetIndexRequest</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">org.elasticsearch.search.builder.SearchSourceBuilder</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.io.IOException</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.HashMap</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#111">java.util.Map</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">CrawlerElasticsearchDao</span> <span style="color:#00a8c8">implements</span> <span style="color:#111">CrawlerDao</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">final</span> <span style="color:#111">String</span> <span style="color:#111">unHandled</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;links_un_handled&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">final</span> <span style="color:#111">String</span> <span style="color:#111">inHandled</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;links_in_handled&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">static</span> <span style="color:#00a8c8">final</span> <span style="color:#111">String</span> <span style="color:#111">news</span> <span style="color:#f92672">=</span> <span style="color:#d88200">&#34;news&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#75af00">CrawlerElasticsearchDao</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">createIndex</span><span style="color:#f92672">(</span><span style="color:#111">unHandled</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">createIndex</span><span style="color:#f92672">(</span><span style="color:#111">inHandled</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">createIndex</span><span style="color:#f92672">(</span><span style="color:#111">news</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;https://sina.cn&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">unHandled</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">Thread</span><span style="color:#f92672">.</span><span style="color:#75af00">sleep</span><span style="color:#f92672">(</span><span style="color:#111">3000</span><span style="color:#f92672">);</span> <span style="color:#75715e">// Waiting for initialization
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">InterruptedException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">e</span><span style="color:#f92672">.</span><span style="color:#75af00">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#111">RestHighLevelClient</span> <span style="color:#75af00">newClient</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RestHighLevelClient</span><span style="color:#f92672">(</span><span style="color:#111">RestClient</span><span style="color:#f92672">.</span><span style="color:#75af00">builder</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#00a8c8">new</span> <span style="color:#111">HttpHost</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;127.0.0.1&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">9200</span><span style="color:#f92672">,</span> <span style="color:#d88200">&#34;http&#34;</span><span style="color:#f92672">)));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">deleteLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">RestHighLevelClient</span> <span style="color:#111">client</span> <span style="color:#f92672">=</span> <span style="color:#111">newClient</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">client</span><span style="color:#f92672">.</span><span style="color:#75af00">delete</span><span style="color:#f92672">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">DeleteRequest</span><span style="color:#f92672">(</span><span style="color:#111">unHandled</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">),</span> <span style="color:#111">RequestOptions</span><span style="color:#f92672">.</span><span style="color:#75af00">DEFAULT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">IOException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">throw</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">,</span> <span style="color:#111">unHandled</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">updateLink</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">,</span> <span style="color:#111">inHandled</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateLink</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">index</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Map</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">,</span> <span style="color:#111">Object</span><span style="color:#f92672">&gt;</span> <span style="color:#111">document</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HashMap</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">document</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;link&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">RestHighLevelClient</span> <span style="color:#111">client</span> <span style="color:#f92672">=</span> <span style="color:#111">newClient</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">client</span><span style="color:#f92672">.</span><span style="color:#75af00">index</span><span style="color:#f92672">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">IndexRequest</span><span style="color:#f92672">(</span><span style="color:#111">index</span><span style="color:#f92672">).</span><span style="color:#75af00">source</span><span style="color:#f92672">(</span><span style="color:#111">document</span><span style="color:#f92672">).</span><span style="color:#75af00">id</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">),</span> <span style="color:#111">RequestOptions</span><span style="color:#f92672">.</span><span style="color:#75af00">DEFAULT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">IOException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">throw</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">updateNews</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">title</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">content</span><span style="color:#f92672">,</span> <span style="color:#111">String</span> <span style="color:#111">url</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">Map</span><span style="color:#f92672">&lt;</span><span style="color:#111">String</span><span style="color:#f92672">,</span> <span style="color:#111">Object</span><span style="color:#f92672">&gt;</span> <span style="color:#111">document</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">HashMap</span><span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">document</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;title&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">title</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">document</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;content&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">content</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">document</span><span style="color:#f92672">.</span><span style="color:#75af00">put</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;url&#34;</span><span style="color:#f92672">,</span> <span style="color:#111">url</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">RestHighLevelClient</span> <span style="color:#111">client</span> <span style="color:#f92672">=</span> <span style="color:#111">newClient</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">client</span><span style="color:#f92672">.</span><span style="color:#75af00">index</span><span style="color:#f92672">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">IndexRequest</span><span style="color:#f92672">(</span><span style="color:#111">news</span><span style="color:#f92672">).</span><span style="color:#75af00">source</span><span style="color:#f92672">(</span><span style="color:#111">document</span><span style="color:#f92672">).</span><span style="color:#75af00">id</span><span style="color:#f92672">(</span><span style="color:#111">url</span><span style="color:#f92672">),</span> <span style="color:#111">RequestOptions</span><span style="color:#f92672">.</span><span style="color:#75af00">DEFAULT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">IOException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">throw</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">boolean</span> <span style="color:#75af00">selectLinksInHandled</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">link</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">RestHighLevelClient</span> <span style="color:#111">client</span> <span style="color:#f92672">=</span> <span style="color:#111">newClient</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">GetResponse</span> <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">client</span><span style="color:#f92672">.</span><span style="color:#75af00">get</span><span style="color:#f92672">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">GetRequest</span><span style="color:#f92672">(</span><span style="color:#111">inHandled</span><span style="color:#f92672">,</span> <span style="color:#111">link</span><span style="color:#f92672">),</span> <span style="color:#111">RequestOptions</span><span style="color:#f92672">.</span><span style="color:#75af00">DEFAULT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">response</span><span style="color:#f92672">.</span><span style="color:#75af00">isExists</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">IOException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">throw</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75af00">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">synchronized</span> <span style="color:#111">String</span> <span style="color:#75af00">removeLinksUnHandled</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">RestHighLevelClient</span> <span style="color:#111">client</span> <span style="color:#f92672">=</span> <span style="color:#111">newClient</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">SearchRequest</span> <span style="color:#111">request</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">SearchRequest</span><span style="color:#f92672">(</span><span style="color:#111">unHandled</span><span style="color:#f92672">).</span><span style="color:#75af00">source</span><span style="color:#f92672">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">SearchSourceBuilder</span><span style="color:#f92672">().</span><span style="color:#75af00">size</span><span style="color:#f92672">(</span><span style="color:#111">1</span><span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">SearchResponse</span> <span style="color:#111">response</span> <span style="color:#f92672">=</span> <span style="color:#111">client</span><span style="color:#f92672">.</span><span style="color:#75af00">search</span><span style="color:#f92672">(</span><span style="color:#111">request</span><span style="color:#f92672">,</span> <span style="color:#111">RequestOptions</span><span style="color:#f92672">.</span><span style="color:#75af00">DEFAULT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">response</span><span style="color:#f92672">.</span><span style="color:#75af00">getHits</span><span style="color:#f92672">().</span><span style="color:#75af00">getTotalHits</span><span style="color:#f92672">().</span><span style="color:#75af00">value</span> <span style="color:#f92672">&lt;</span> <span style="color:#111">1</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">String</span> <span style="color:#111">link</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#111">String</span><span style="color:#f92672">)</span> <span style="color:#111">response</span><span style="color:#f92672">.</span><span style="color:#75af00">getHits</span><span style="color:#f92672">().</span><span style="color:#75af00">getAt</span><span style="color:#f92672">(</span><span style="color:#111">0</span><span style="color:#f92672">).</span><span style="color:#75af00">getSourceAsMap</span><span style="color:#f92672">().</span><span style="color:#75af00">get</span><span style="color:#f92672">(</span><span style="color:#d88200">&#34;link&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(</span><span style="color:#111">link</span> <span style="color:#f92672">==</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">)</span> <span style="color:#00a8c8">return</span> <span style="color:#00a8c8">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#111">deleteLinksUnHandled</span><span style="color:#f92672">(</span><span style="color:#111">link</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">return</span> <span style="color:#111">link</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">IOException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">throw</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">void</span> <span style="color:#75af00">createIndex</span><span style="color:#f92672">(</span><span style="color:#111">String</span> <span style="color:#111">index</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">try</span> <span style="color:#f92672">(</span><span style="color:#111">RestHighLevelClient</span> <span style="color:#111">client</span> <span style="color:#f92672">=</span> <span style="color:#111">newClient</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">if</span> <span style="color:#f92672">(!</span><span style="color:#111">client</span><span style="color:#f92672">.</span><span style="color:#75af00">indices</span><span style="color:#f92672">().</span><span style="color:#75af00">exists</span><span style="color:#f92672">(</span><span style="color:#00a8c8">new</span> <span style="color:#111">GetIndexRequest</span><span style="color:#f92672">(</span><span style="color:#111">index</span><span style="color:#f92672">),</span> <span style="color:#111">RequestOptions</span><span style="color:#f92672">.</span><span style="color:#75af00">DEFAULT</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">CreateIndexRequest</span> <span style="color:#111">request</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">new</span> <span style="color:#111">CreateIndexRequest</span><span style="color:#f92672">(</span><span style="color:#111">index</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#111">client</span><span style="color:#f92672">.</span><span style="color:#75af00">indices</span><span style="color:#f92672">().</span><span style="color:#75af00">create</span><span style="color:#f92672">(</span><span style="color:#111">request</span><span style="color:#f92672">,</span> <span style="color:#111">RequestOptions</span><span style="color:#f92672">.</span><span style="color:#75af00">DEFAULT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span> <span style="color:#00a8c8">catch</span> <span style="color:#f92672">(</span><span style="color:#111">IOException</span> <span style="color:#111">e</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#00a8c8">throw</span> <span style="color:#00a8c8">new</span> <span style="color:#111">RuntimeException</span><span style="color:#f92672">(</span><span style="color:#111">e</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="最终效果">最终效果</h2>
<p><img src="/images/project-test-crawler/07.png" alt="效果"></p>

<script src="https://utteranc.es/client.js"
        repo="Wjinlei/wjinlei.github.io"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

</div>
</div><p class="footer text-center color-999">标签列表</p>

  <a class="footer" href="http://wjinlei.github.io/tags/ccna/">ccna</a>

  <a class="footer" href="http://wjinlei.github.io/tags/compression/">compression</a>

  <a class="footer" href="http://wjinlei.github.io/tags/docker/">docker</a>

  <a class="footer" href="http://wjinlei.github.io/tags/golang/">golang</a>

  <a class="footer" href="http://wjinlei.github.io/tags/hugo/">hugo</a>

  <a class="footer" href="http://wjinlei.github.io/tags/java/">java</a>

  <a class="footer" href="http://wjinlei.github.io/tags/linux/">Linux</a>

  <a class="footer" href="http://wjinlei.github.io/tags/mame/">MAME</a>

  <a class="footer" href="http://wjinlei.github.io/tags/maven/">Maven</a>

  <a class="footer" href="http://wjinlei.github.io/tags/mybatis/">MyBatis</a>

  <a class="footer" href="http://wjinlei.github.io/tags/pyenv/">pyenv</a>

  <a class="footer" href="http://wjinlei.github.io/tags/raylib/">raylib</a>

  <a class="footer" href="http://wjinlei.github.io/tags/rust/">rust</a>

  <a class="footer" href="http://wjinlei.github.io/tags/spring/">Spring</a>

  <a class="footer" href="http://wjinlei.github.io/tags/springboot/">Springboot</a>

  <a class="footer" href="http://wjinlei.github.io/tags/sql/">Sql</a>

  <a class="footer" href="http://wjinlei.github.io/tags/%E6%8B%B3%E7%9A%8797/">拳皇97</a>

  <a class="footer" href="http://wjinlei.github.io/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a>

  <a class="footer" href="http://wjinlei.github.io/tags/%E6%A8%A1%E6%8B%9F%E5%99%A8/">模拟器</a>

  <a class="footer" href="http://wjinlei.github.io/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">正则表达式</a>

  <a class="footer" href="http://wjinlei.github.io/tags/%E6%B8%B8%E6%88%8F%E5%BC%95%E6%93%8E/">游戏引擎</a>

  <a class="footer" href="http://wjinlei.github.io/tags/%E7%AE%97%E6%B3%95/">算法</a>


<p class="footer text-center color-999">&copy; 2022 <a href="https://github.com/Wjinlei">Jerry Wang</a></p>
<p class="footer text-center color-999">由 <a href="https://gohugo.io">Hugo</a> 强力驱动</p>
<script src="/js/feather.min.js"></script>
<script src="/js/fuse.min.js"></script>
<script src="/js/fastsearch.js"></script>
<script>
  feather.replace({ width: 18, height: 14, "stroke-width": 1.8 });

  let randomPostList = document.getElementById("random-post-list");
  if (randomPostList !== null) {
    fetchJSONFile("/index.json", function (data) {
      var options = {
        
        minMatchCharLength: 2,
        shouldSort: true,
        ignoreLocation: true,
        threshold: 0.0,
        keys: ["title"]
      };
      
      fuseIndex = Fuse.createIndex(options.keys, data);
      fuse = new Fuse(data, options, fuseIndex); 

      let permalinks = [];
      let html = "";
      for (var i = 0; i < 50; i++) {
        var index = Math.floor(Math.random() * fuse._docs.length);
        if (index >= fuse._docs.length) {
          break;
        }

        if (permalinks.includes(fuse._docs[index].permalink)) {
          continue;
        }

        html = html + '<li><a href="' + fuse._docs[index].permalink + '">' + '<span class="title">' + fuse._docs[index].title + "</span></a></li>";
        permalinks.push(fuse._docs[index].permalink);
        fuse.removeAt(index);
      }
      randomPostList.innerHTML = html;
    });
  }
</script>
</body>
</html>
